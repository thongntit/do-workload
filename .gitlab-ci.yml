image: docker:19.03.8

services:
  - docker:19.03.8-dind

before_script:
  - apk add -qU openssh
  - mkdir -p ~/.ssh
  - cp $SSH_CONFIG ~/.ssh/config
  - cp $SSH_KEY ~/.ssh/hiraism
  - chmod 400 ~/.ssh/hiraism
  - ssh-keyscan api.thongnt.com >> ~/.ssh/known_hosts
  - export DOCKER_HOST="ssh://root@api.thongnt.com"
stages:
  - particle-apply-router
  - particle-apply-database
  - particle-apply-services

Rolling Update Traefik:
  stage: particle-apply-router
  script:
    - docker stack deploy --compose-file stacks/traefik/docker-compose.yml traefik

  only:
    changes:
      - stacks/traefik/*

Rolling Update Database:
  stage: particle-apply-database
  script:
    - docker stack deploy --compose-file stacks/database/docker-compose.yml database

  only:
    changes:
      - stacks/database/*

Rolling Update Todo:
  stage: particle-apply-services
  script:
    - docker stack deploy --compose-file stacks/todo-app/docker-compose.yml todo

  only:
    changes:
      - stacks/todo-app/*

Rolling Update Echo:
  stage: particle-apply-services
  script:
    - docker stack deploy --compose-file stacks/echo/docker-compose.yml echo

  only:
    changes:
      - stacks/echo/*