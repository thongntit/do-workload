image: docker:19.03.8

services:
  - docker:19.03.8-dind

before_script:
  - apk add --no-cache python3
  - pip3 install docker-compose
  - chmod +x /usr/local/bin/docker-compose
  - mkdir -p ~/.ssh
  - cp $SSH_CONFIG ~/.ssh/config
  - cp $SSH_KEY ~/.ssh/aws.pem
  - chmod 400 ~/.ssh/aws.pem
  - ssh-keyscan api.thongnt.space >> ~/.ssh/known_hosts
  - export DOCKER_HOST="ssh://ec2-user@api.thongnt.space"
stages:
  - particle-apply

Rolling Update:
  stage: particle-apply
  script:
    - docker-compose -f stacks/todo-app/docker-compose.yml pull
    - docker stack deploy --compose-file stacks/todo-app/docker-compose.yml todo

  only:
    changes:
      - stacks/todo-app/*
# Deploy:
#   stage: deploy
#   before_script:
#   - mkdir -p ~/.ssh
#   - cp $SSH_CONFIG ~/.ssh/config
#   - cp $SSH_KEY ~/.ssh/aws.pem
#   - chmod 400 ~/.ssh/aws.pem
#   - ssh-keyscan api.thongnt.space >> ~/.ssh/known_hosts
#   - export DOCKER_HOST="ssh://ec2-user@api.thongnt.space"
#   script:
#     - docker service update --image $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA todo_todo-be
#   only:
#     - master
